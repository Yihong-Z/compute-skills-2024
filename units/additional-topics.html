<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Numerics, reproducibility, and automation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/styles.css">
<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../units/comp-practices.html">Modules</a></li><li class="breadcrumb-item"><a href="../units/additional-topics.html">Numerics and Reproducibility</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../assets/stat_bear.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Computational Skills Workshop</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/berkeley-scf/compute-skills-2024" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home / Schedule</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../prep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computational Environment</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Modules</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/comp-practices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computational Tools and Practices</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/additional-topics.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Numerics and Reproducibility</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/intro-computing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro to Computing and Command Line (optional)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/intro-python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro to Python (optional)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/mini-project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python Mini Project (optional)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../license.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">License</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#numerical-analysis-and-random-number-generation" id="toc-numerical-analysis-and-random-number-generation" class="nav-link active" data-scroll-target="#numerical-analysis-and-random-number-generation">8. Numerical analysis and random number generation</a>
  <ul class="collapse">
  <li><a href="#random-number-generation" id="toc-random-number-generation" class="nav-link" data-scroll-target="#random-number-generation">Random number generation</a>
  <ul class="collapse">
  <li><a href="#random-number-seed" id="toc-random-number-seed" class="nav-link" data-scroll-target="#random-number-seed">Random number seed</a></li>
  <li><a href="#random-number-generators" id="toc-random-number-generators" class="nav-link" data-scroll-target="#random-number-generators">Random number generators</a></li>
  </ul></li>
  <li><a href="#floating-point-precision" id="toc-floating-point-precision" class="nav-link" data-scroll-target="#floating-point-precision">Floating point precision</a>
  <ul class="collapse">
  <li><a href="#double-precision-accuracy" id="toc-double-precision-accuracy" class="nav-link" data-scroll-target="#double-precision-accuracy">Double-precision accuracy</a></li>
  <li><a href="#comparisons" id="toc-comparisons" class="nav-link" data-scroll-target="#comparisons">Comparisons</a></li>
  <li><a href="#calculation-errors" id="toc-calculation-errors" class="nav-link" data-scroll-target="#calculation-errors">Calculation errors</a></li>
  <li><a href="#linear-algebra-errors" id="toc-linear-algebra-errors" class="nav-link" data-scroll-target="#linear-algebra-errors">Linear algebra errors</a></li>
  <li><a href="#overflow-and-underflow" id="toc-overflow-and-underflow" class="nav-link" data-scroll-target="#overflow-and-underflow">Overflow and underflow</a></li>
  </ul></li>
  <li><a href="#work-with-probabilities-and-densities-on-the-log-scale.-almost-always." id="toc-work-with-probabilities-and-densities-on-the-log-scale.-almost-always." class="nav-link" data-scroll-target="#work-with-probabilities-and-densities-on-the-log-scale.-almost-always.">Work with probabilities and densities on the log scale. Almost always.</a></li>
  <li><a href="#exercise-numerical-issues-with-newtons-method" id="toc-exercise-numerical-issues-with-newtons-method" class="nav-link" data-scroll-target="#exercise-numerical-issues-with-newtons-method">Exercise: numerical issues with Newton’s method</a></li>
  </ul></li>
  <li><a href="#packaging-and-conda-environments" id="toc-packaging-and-conda-environments" class="nav-link" data-scroll-target="#packaging-and-conda-environments">9. Packaging and Conda environments</a>
  <ul class="collapse">
  <li><a href="#basic-python-packages" id="toc-basic-python-packages" class="nav-link" data-scroll-target="#basic-python-packages">Basic Python packages</a>
  <ul class="collapse">
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages">Packages</a></li>
  <li><a href="#a-minimal-real-package" id="toc-a-minimal-real-package" class="nav-link" data-scroll-target="#a-minimal-real-package">A minimal “real” package</a></li>
  </ul></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise">Exercise</a></li>
  <li><a href="#installing-packages" id="toc-installing-packages" class="nav-link" data-scroll-target="#installing-packages">Installing packages</a>
  <ul class="collapse">
  <li><a href="#reproducibility-and-package-management" id="toc-reproducibility-and-package-management" class="nav-link" data-scroll-target="#reproducibility-and-package-management">Reproducibility and package management</a></li>
  <li><a href="#package-locations" id="toc-package-locations" class="nav-link" data-scroll-target="#package-locations">Package locations</a></li>
  <li><a href="#source-vs.-binary-packages" id="toc-source-vs.-binary-packages" class="nav-link" data-scroll-target="#source-vs.-binary-packages">Source vs.&nbsp;binary packages</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#github-actions-and-continuous-integration" id="toc-github-actions-and-continuous-integration" class="nav-link" data-scroll-target="#github-actions-and-continuous-integration">10. GitHub Actions and Continuous Integration</a>
  <ul class="collapse">
  <li><a href="#docker-containers" id="toc-docker-containers" class="nav-link" data-scroll-target="#docker-containers">Docker containers</a></li>
  <li><a href="#binder" id="toc-binder" class="nav-link" data-scroll-target="#binder">Binder</a></li>
  <li><a href="#github-actions" id="toc-github-actions" class="nav-link" data-scroll-target="#github-actions">GitHub Actions</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../units/comp-practices.html">Modules</a></li><li class="breadcrumb-item"><a href="../units/additional-topics.html">Numerics and Reproducibility</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Numerics, reproducibility, and automation</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DRAFT CONTENT (2024-08-01)
</div>
</div>
<div class="callout-body-container callout-body">
<p>This module is drafted but still under construction.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Overview
</div>
</div>
<div class="callout-body-container callout-body">
<p>This module presents some information on numerical analysis (random number generation and floating point precision), packaging, reproducibility, and automation.</p>
</div>
</div>
<section id="numerical-analysis-and-random-number-generation" class="level1">
<h1>8. Numerical analysis and random number generation</h1>
<section id="random-number-generation" class="level2">
<h2 class="anchored" data-anchor-id="random-number-generation">Random number generation</h2>
<p>Random numbers on a computer are actually (periodic) deterministic sequences that (hopefully) behave as if they were random.</p>
<section id="random-number-seed" class="level3">
<h3 class="anchored" data-anchor-id="random-number-seed">Random number seed</h3>
<p>The <em>seed</em> determines where in the cycle of the periodic sequence you are.</p>
<p>It’s critical for ensuring reproducibility when running code that uses random numbers</p>
<div id="f49c21d3" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>array([ 1.62434536, -0.61175641, -0.52817175, -1.07296862,  0.86540763])</code></pre>
</div>
</div>
<div id="d37e360c" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>array([-2.3015387 ,  1.74481176, -0.7612069 ,  0.3190391 , -0.24937038])</code></pre>
</div>
</div>
<div id="d908145d" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>np.random.normal(size <span class="op">=</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>array([ 1.62434536, -0.61175641, -0.52817175, -1.07296862,  0.86540763,
       -2.3015387 ,  1.74481176, -0.7612069 ,  0.3190391 , -0.24937038])</code></pre>
</div>
</div>
</section>
<section id="random-number-generators" class="level3">
<h3 class="anchored" data-anchor-id="random-number-generators">Random number generators</h3>
<p>If you don’t do anything, numpy will use a generator called the Mersenne Twister (that’s the default in R too).</p>
<p>However the “default” RNG in numpy is a newer, better algorithm called PCG64.</p>
<div id="735d44d1" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Mersenne twister</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>array([ 1.62434536, -0.61175641, -0.52817175, -1.07296862,  0.86540763])</code></pre>
</div>
</div>
<div id="788171bb" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Mersenne twister, selected specifically</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.Generator(np.random.MT19937(seed <span class="op">=</span> <span class="dv">1</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>rng.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">## Not clear why numbers differ from above. Seed setup might differ.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>array([ 2.04676909, -1.03653009,  0.72997546,  0.41584996, -0.1922969 ])</code></pre>
</div>
</div>
<div id="6dcdf73e" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">## 'Default' PCG64</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.Generator(np.random.PCG64(seed <span class="op">=</span> <span class="dv">1</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>rng.normal(size <span class="op">=</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>array([ 0.34558419,  0.82161814,  0.33043708, -1.30315723,  0.90535587])</code></pre>
</div>
</div>
<div id="424f47f5" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(seed <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>rng.normal(size <span class="op">=</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>array([ 0.34558419,  0.82161814,  0.33043708, -1.30315723,  0.90535587])</code></pre>
</div>
</div>
<p>Some cautions (<a href="https://arxiv.org/pdf/1810.10985">detailed by Philip Stark and Kellie Ottoboni</a>):</p>
<ul>
<li>seeds with many zeros can be problematic.</li>
<li>Mersenne Twister not as good as PCG64.</li>
<li>Be particularly cautious to use a good RNG when doing permutation and taking random samples.</li>
</ul>
</section>
</section>
<section id="floating-point-precision" class="level2">
<h2 class="anchored" data-anchor-id="floating-point-precision">Floating point precision</h2>
<div id="07ccf46b" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fl">0.3</span> <span class="op">-</span> <span class="fl">0.2</span> <span class="op">==</span> <span class="fl">0.1</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fl">0.3</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fl">0.2</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fl">0.1</span> <span class="co"># Hmmm...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>0.1</code></pre>
</div>
</div>
<section id="double-precision-accuracy" class="level3">
<h3 class="anchored" data-anchor-id="double-precision-accuracy">Double-precision accuracy</h3>
<p>Numbers in most languages are stored by default as double precision floating point numbers.</p>
<ul>
<li>8 bytes = 64 bits = double precision</li>
<li>4 bytes = 32 bits = single precision</li>
</ul>
<p>(GPU libraries often use 4 bytes or even fewer.)</p>
<div id="2135fbc4" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dg(x, form <span class="op">=</span> <span class="st">'.20f'</span>):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">format</span>(x, form))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>dg(a)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>dg(b)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>dg(a<span class="op">-</span>b)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>dg(<span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>0.29999999999999998890
0.20000000000000001110
0.09999999999999997780
0.10000000000000000555</code></pre>
</div>
</div>
<p>How many digits of accuracy do we have?</p>
<p>Same thing regardless of the size of the number:</p>
<div id="275287f9" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fl">12345678.1234567812345678</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>12345678.123456782</code></pre>
</div>
</div>
<div id="daa05cfa" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fl">12345678123456781234.5678</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>1.234567812345678e+19</code></pre>
</div>
</div>
<div id="8ff7ec90" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dg(<span class="fl">12345678123456781234.5678</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>12345678123456780288.00000000000000000000</code></pre>
</div>
</div>
<p>This occurs because of how the 64 bits in a double precision floating point number are allocated to give a large range of numbers in terms of magnitude and high precision in terms of digits of accuracy.</p>
</section>
<section id="comparisons" class="level3">
<h3 class="anchored" data-anchor-id="comparisons">Comparisons</h3>
<p>Let’s see what kinds of numbers we can safely compare for exact equality with <code>==</code>.</p>
<div id="f7c6579b" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">.5</span> <span class="op">-</span> <span class="fl">.2</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="fl">0.3</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">1.5</span> <span class="op">-</span> <span class="fl">.2</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="fl">0.3</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">.5</span> <span class="op">-</span> <span class="fl">.5</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">.5</span> <span class="op">-</span> <span class="fl">.2</span>  <span class="op">-</span><span class="fl">.3</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> (<span class="fl">.5</span> <span class="op">-</span> <span class="fl">.2</span>) <span class="op">-</span> (<span class="fl">.51</span> <span class="op">-</span> <span class="fl">.21</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>np.isclose(x, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="calculation-errors" class="level3">
<h3 class="anchored" data-anchor-id="calculation-errors">Calculation errors</h3>
<p>Let’s consider accuracy of subtraction.</p>
<div id="a3224821" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1.1234</span> <span class="op">-</span> <span class="fl">1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>0.12339999999999995</code></pre>
</div>
</div>
<div id="0fa27afe" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fl">123456781234.1234</span> <span class="op">-</span> <span class="fl">123456781234.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>0.1233978271484375</code></pre>
</div>
</div>
<p>This is called catastrophic cancellation.</p>
<p>Do you think calling it “catastrophic” is too extreme? If so, consider this.</p>
<div id="4eadd4d0" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fl">81.0</span> <span class="op">-</span> <span class="fl">80.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>1.0</code></pre>
</div>
</div>
<div id="628a7526" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fl">12345678123456781.0</span> <span class="op">-</span><span class="fl">12345678123456780.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>0.0</code></pre>
</div>
</div>
<p>What’s the derivative of <span class="math inline">\(sin(x)\)</span>? Let’s see what kind of accuracy we can get.</p>
<div id="3f5c9230" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> deriv(f, x, eps<span class="op">=</span><span class="fl">1e-8</span>):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> (f(x<span class="op">+</span>eps) <span class="op">-</span> f(x)) <span class="op">/</span> eps</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>np.cos(<span class="fl">0.2</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-12</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-14</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-15</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-16</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-17</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="linear-algebra-errors" class="level3">
<h3 class="anchored" data-anchor-id="linear-algebra-errors">Linear algebra errors</h3>
<p>The errors seen in doing calculations, such as catastrophic cancellation, cascaded through derivative estimation. That also happens when doing linear algebra operations.</p>
<p>Here’s an example where mathematically all the eigenvalues are real-valued and positive, but not on the computer.</p>
<div id="0d559eec" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy <span class="im">as</span> sp</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> np.arange(<span class="dv">100</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>dists <span class="op">=</span> np.<span class="bu">abs</span>(xs[:, np.newaxis] <span class="op">-</span> xs)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a p.d. matrix (mathematically).</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="op">=</span> np.exp(<span class="op">-</span>(dists<span class="op">/</span><span class="dv">10</span>)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co"># But not numerically...</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>sp.linalg.eigvals(corr_matrix)[<span class="dv">80</span>:<span class="dv">99</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>array([ 1.43024256e-16+1.28433951e-16j,  1.43024256e-16-1.28433951e-16j,
        1.49210347e-16+4.87070558e-17j,  1.49210347e-16-4.87070558e-17j,
       -1.54661687e-16+1.25601177e-16j, -1.54661687e-16-1.25601177e-16j,
       -2.07808543e-16+3.73312254e-17j, -2.07808543e-16-3.73312254e-17j,
        9.83783628e-17+7.20174529e-17j,  9.83783628e-17-7.20174529e-17j,
        2.37821218e-18+1.00101181e-16j,  2.37821218e-18-1.00101181e-16j,
        5.29254936e-17+0.00000000e+00j, -1.62444574e-16+0.00000000e+00j,
       -2.74621910e-17+7.55223038e-17j, -2.74621910e-17-7.55223038e-17j,
       -9.08016006e-17+3.79199791e-17j, -9.08016006e-17-3.79199791e-17j,
       -3.25243092e-17+0.00000000e+00j])</code></pre>
</div>
</div>
</section>
<section id="overflow-and-underflow" class="level3">
<h3 class="anchored" data-anchor-id="overflow-and-underflow">Overflow and underflow</h3>
<p>Having a finite number of bits to represent each number means there are minimum and maximum numbers that can be expressed.</p>
<div id="f6769cab" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1.38e5000</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fl">1.38e-400</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>0.0</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How much do we need to worry about overflow and underflow?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Q: Roughly how many observations would it take before we underflow in calculating a likelihood?</p>
<ul>
<li>10</li>
<li>100</li>
<li>1000</li>
<li>100000</li>
<li>100000000</li>
</ul>
</div>
</div>
<div id="f160e1ac" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy <span class="im">as</span> sp</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size<span class="op">=</span>n)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>np.prod(sp.stats.norm.pdf(x))</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>loglik <span class="op">=</span> np.<span class="bu">sum</span>(sp.stats.norm.logpdf(x))</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>loglik</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>np.exp(loglik)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>2.0739518337814167e-08</code></pre>
</div>
</div>
</section>
</section>
<section id="work-with-probabilities-and-densities-on-the-log-scale.-almost-always." class="level2 {callout-important}">
<h2 class="anchored" data-anchor-id="work-with-probabilities-and-densities-on-the-log-scale.-almost-always.">Work with probabilities and densities on the log scale. Almost always.</h2>
</section>
<section id="exercise-numerical-issues-with-newtons-method" class="level2">
<h2 class="anchored" data-anchor-id="exercise-numerical-issues-with-newtons-method">Exercise: numerical issues with Newton’s method</h2>
<p>Look at your partner’s code in terms of how it handles the stopping criterion or (for the 1-d case) the finite difference estimate of the gradient and Hessian.</p>
<p>Make a pull request that tries to improve how that is handled.</p>
<p>Then review the pull request your partner makes in your repository.</p>
</section>
</section>
<section id="packaging-and-conda-environments" class="level1">
<h1>9. Packaging and Conda environments</h1>
<section id="basic-python-packages" class="level2">
<h2 class="anchored" data-anchor-id="basic-python-packages">Basic Python packages</h2>
<p>What’s a package? In general it is software that is provided as a bundle that can be downloaded and made available on your computer. Some packages (e.g., R, Python themselves) are stand-alone packages. Others (such as R packages and Python packages) are add-on functionality that works with stand-alone software.</p>
<p>What do we need to have a Python package?</p>
<section id="packages" class="level3">
<h3 class="anchored" data-anchor-id="packages">Packages</h3>
<p>A Python package is a directory containing one or more modules and with a file named <code>__init__.py</code> that is called when a package is imported and serves to initialize the package.</p>
<p>Let’s create a basic package.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> mypkg</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mypkg/__init__.py</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="st">## Make objects from mymod.py available as mypkg.foo</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="st">from mypkg.mymod import *</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="st">print("Welcome to my package.")</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mypkg/mymod.py</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="st">x = 7</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="st">def myfun(val):</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="st">    print("The arg is: ", str(val), ".", sep = '')</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that if there were other modules, we could have imported from those as well.</p>
<p>Now we can use the objects from the module without having to know that it was in a particular module (because of how <code>__init__.py</code> was set up).</p>
<div id="bdb525e1" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mypkg</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>mypkg.x</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>mypkg.myfun(<span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that one can set <code>__all__</code> in an <code>__init__.py</code> to define what is imported, which makes clear what is publicly available and hides what is considered internal.</p>
</section>
<section id="a-minimal-real-package" class="level3">
<h3 class="anchored" data-anchor-id="a-minimal-real-package">A minimal “real” package</h3>
<p>Fernando has a <a href="https://github.com/fperez/mytoy">this toy example package</a>.</p>
<p>Let’s clone the repository and see if we can install it.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/fperez/mytoy</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> mytoy</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">--user</span> .</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> .local/lib/python3.11/site-packages</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="d9d5ff18" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mytoy</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>mytoy.toy(<span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It would take more work to make the package available in a repository such as PyPI or via Conda.</p>
</section>
</section>
<section id="exercise" class="level2">
<h2 class="anchored" data-anchor-id="exercise">Exercise</h2>
<p>Make a package out of your Newton method code, following the structure of <code>mytoy</code>. Include your tests as part of the package.</p>
<p>See if you can install your package, run the tests, and use the package, following the <code>README.md</code> of <code>mytoy</code>.</p>
</section>
<section id="installing-packages" class="level2">
<h2 class="anchored" data-anchor-id="installing-packages">Installing packages</h2>
<p>If a package is on PyPI or available through Conda but not on your system, you can install it easily (usually). You don’t need root permission on a machine to install a package, though you may need to use <code>pip install --user</code> or set up a new Conda environment.</p>
<p>Packages often depend on other packages. In general, if one package depends on another, pip or conda will generally install the dependency automatically.</p>
<p>One advantage of Conda is that it can also install non-Python packages on which a Python package depends, whereas with pip you sometimes need to install a system package to satisfy a dependency.</p>
<p>It’s not uncommon to run into a case where conda has trouble installing a package because of version inconsistencies amongst the dependencies. <code>mamba</code> is a drop-in replacement for <code>conda</code> and often does a better job of this “dependency resolution”. <a href="https://statistics.berkeley.edu/computing/software/install">We use <code>mamba</code> by default on the SCF</a>.</p>
<section id="reproducibility-and-package-management" class="level3">
<h3 class="anchored" data-anchor-id="reproducibility-and-package-management">Reproducibility and package management</h3>
<p>For reproducibility, it’s important to know the versions of the packages you use (and the version of Python). <code>pip</code> and <code>conda</code> make it easy to do this. You can create a <em>requirements</em> file that captures the packages you are currently using (and, critically, their versions) and then install exactly that set of packages (and versions) based on that requirements file.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Reproducing using pip.</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> freeze <span class="op">&gt;</span> requirements.txt</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">## Reproducing a Conda environment.</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env export <span class="op">&gt;</span> environment.yml</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create <span class="at">-f</span> environment.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Conda is a general package manager. You can use it to manage Python packages but lots of other software as well, including R and Julia.</p>
<section id="fully-isolating-your-conda-environment" class="level4">
<h4 class="anchored" data-anchor-id="fully-isolating-your-conda-environment">Fully isolating your Conda environment</h4>
<p>Conda environments provide an additional layer of modularity/reproducibility, allowing you to set up a fully reproducible environment for your computation. Here (by explicitly giving <code>python=3.11</code>) the Python 3.11 executable and all packages you install in the environment are fully independent (there are <a href="https://statistics.berkeley.edu/computing/software/install#conda-isolate">some caveats</a> of whatever Python executables are installed on the system.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> python</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-n</span> my_iso_env python=3.11</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> activate my_iso_env</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> python</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install numpy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Activating an environment
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you use <code>conda activate</code> rather than <code>source activate</code>, Conda will prompt you to run <code>conda init</code>, which will make changes to your <code>~/.bashrc</code> that, for one, activate the Conda base environment automatically when a shell is started. This may be fine, but it’s helpful to be aware.</p>
</div>
</div>
</section>
</section>
<section id="package-locations" class="level3">
<h3 class="anchored" data-anchor-id="package-locations">Package locations</h3>
<p>Packages in Python (and in R, Julia, etc.) may be installed in various places on the filesystem, and it sometimes it is helpful (e.g., if you end up with multiple versions of a package installed on your system) to be able to figure out where on the filesystem the package is being loaded from.</p>
<ul>
<li><code>pkgname.__file__</code> will show where the imported package is installed.</li>
<li><code>pkname.__version__</code> will show the version of the package (as will <code>pip list</code> or <code>conda list</code>, for all packages).</li>
<li><code>sys.path</code> shows where Python looks for packages on your system.
<ul>
<li>packages installed via <code>pip</code> will generally be in <code>~/.local/lib/python3.X/site-packages</code>.</li>
</ul></li>
</ul>
</section>
<section id="source-vs.-binary-packages" class="level3">
<h3 class="anchored" data-anchor-id="source-vs.-binary-packages">Source vs.&nbsp;binary packages</h3>
<p>The difference between a <em>source</em> package and a <em>binary</em> package is that - a <em>source</em> package has the raw Python (and C/C++ and Fortran, in some cases) code as text files - a <em>binary</em> package has all the non-Python code in a binary/non-text format, with the C/C++ and Fortran code already having been compiled.</p>
<p>If you install a package from source, C/C++/Fortran code will be compiled on your system (if the package has such code). That should mean the compiled code will work on your system, but requires you to have a compiler available and things properly configured. A binary package doesn’t need to be compiled on your system, but in some cases (e.g., if you got the wrong binary version) the code may not run on your system because it was compiled in such a way that is not compatible with your system.</p>
<p>Python <em>wheels</em> are a binary package format for Python packages. Wheels for some packages will vary by platform (i.e., operating system) so that the package will install correctly on the system where it is being installed.</p>
</section>
</section>
</section>
<section id="github-actions-and-continuous-integration" class="level1">
<h1>10. GitHub Actions and Continuous Integration</h1>
<p>[VERY MUCH UNDER CONSTRUCTION]</p>
<p>Having reproducible environments (e.g., Conda environments or Docker containers) provides the ability to run (and automate) various actions to run on remote/cloud computational resources and know that they (should) work.</p>
<section id="docker-containers" class="level2 {callout-tip}">
<h2 class="anchored" data-anchor-id="docker-containers">Docker containers</h2>
<p>Docker containers share some similarities with Conda environments except that you provide a full specification for the Linux operating system you want to use and software you want installed.</p>
</section>
<p>You need to provide the recipe for the environment or container. The automation system can then set up the environment as a virtual environment/container on the remote machine and run the action/code you request. This could simply be giving you a terminal or starting a Jupyter notebook in the environment and giving you access via your browser.</p>
<p>Below are a couple examples.</p>
<p>There are a lot more out there. In fact, DataHub is based on Docker containers (and a container management service called Kubernetes). Let’s see what OS is being run in the container that your DataHub server is using.</p>
<pre><code>$ cat /etc/issue
Ubuntu 22.04.4 LTS \n \l</code></pre>
<section id="binder" class="level2">
<h2 class="anchored" data-anchor-id="binder">Binder</h2>
<p>One example is using Binder to open a Jupyter notebook in an executable environment.</p>
<p>Based on a configuration (various options are possible for how to specify the configuration), Binder will create a Docker container with the needed software installed.</p>
<p>The most common configuration format is to provide a Conda environment file. Binder will then create a Conda environment inside the Docker (Linux) container. The Conda environment will contain the packages specified in the environment file.</p>
<p>Let’s set up a Binder environment “Geospatial analytics in Python with Geopandas” that can access the <a href="https://github.com/jorisvandenbossche/geopandas-tutorial">notebooks and materials provided in the repository</a> in a <a href="https://github.com/jorisvandenbossche/geopandas-tutorial/blob/main/environment.yml">computational environment</a> designed to use the notebooks reliably and reproducibly.</p>
<p>In some cases an <em>image</em> for the container will already be available, and all that needs to happen is to start a virtual machine using that image as the computational environment.</p>
<p>In other cases (e.g., with a configuration you’ve just created), the Docker container and Conda environment need to be set up.</p>
<p>If we’re familiar with what happens when Docker containers and Conda environments are set up, we can see in the Binder logs that a Docker container is set up (using Ubuntu Linux) and one of the steps of doing that is to create a Conda environment within the container. We’ll see that if we use the <code>mytoy</code> repository to start a Binder environment at <code>ovh.mybinder.org</code>, specifying <code>fperez/mytoy</code> as the repository. (Note that in a number of cases, the startup has failed, probably because <code>mybinder</code> has very limited resources for providing cloud compute resources. I am using <code>ovh.mybinder.org</code> rather than <code>mybinder.org</code> in hopes that is more likely to succeed.</p>
</section>
<section id="github-actions" class="level2">
<h2 class="anchored" data-anchor-id="github-actions">GitHub Actions</h2>
<p>A second example is using GitHub Actions (GHA) to automate activities such as testing. To set up a GitHub Actions workflow, one</p>
<ul>
<li>specifies when the workflow will run (e.g., when a push or pull request is made, or only manually)</li>
<li>provides instructions for how to set up the environment for the workflow</li>
<li>provides the operations that the workflow should run.</li>
</ul>
<p>A good example is running tests whenever you make a commit to a repository containing software.</p>
<p>With GHA, you specify the operating system and then run the steps you specify in <code>.github/workflows/some_action.yml</code>. Some steps will customize the environment as the initial steps and then additional step(s) will run shell or other code to run your workflow. You use pre-specified operations (called <em>actions</em>) to do common things (such as checking out a GitHub repository and installing commonly used software).</p>
<p>GH will then run the steps in a virtual machine, which is called the <em>runner</em>.</p>
<p>[TODO: Find an interesting repo with automated testing set up]</p>
<p>[TODO: show how environment is created]</p>
<p>[TODO: show how env is customized]</p>
<p>This is all quite powerful, and the use of reproducible environments generally helps with debugging because you can also set up the environment on your own machine. That said, running code remotely or in the cloud can also be hard to debug at times.</p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/berkeley-scf\.github\.io\/compute-skills-2024");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb48" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Numerics, reproducibility, and automation"</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">    css: ../styles.css</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-block-background: true</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: auto</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="fu">## DRAFT CONTENT (2024-08-01)</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>This module is drafted but still under construction.</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>This module presents some information on numerical analysis (random number generation and floating point precision), packaging, reproducibility, and automation.</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a><span class="fu"># 8. Numerical analysis and random number generation</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random number generation</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>Random numbers on a computer are actually (periodic) deterministic sequences that (hopefully) behave as if they were random.</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random number seed</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>The *seed* determines where in the cycle of the periodic sequence you are.</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>It's critical for ensuring reproducibility when running code that uses random numbers</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>np.random.normal(size <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random number generators</span></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>If you don't do anything, numpy will use a generator called the Mersenne Twister (that's the default in R too).</span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>However the "default" RNG in numpy is a newer, better algorithm called PCG64. </span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a><span class="co">## Mersenne twister</span></span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a><span class="co">## Mersenne twister, selected specifically</span></span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.Generator(np.random.MT19937(seed <span class="op">=</span> <span class="dv">1</span>))</span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>rng.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a><span class="co">## Not clear why numbers differ from above. Seed setup might differ.</span></span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a><span class="co">## 'Default' PCG64</span></span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.Generator(np.random.PCG64(seed <span class="op">=</span> <span class="dv">1</span>))</span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>rng.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(seed <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>rng.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a>Some cautions (<span class="co">[</span><span class="ot">detailed by Philip Stark and Kellie Ottoboni</span><span class="co">](https://arxiv.org/pdf/1810.10985)</span>):</span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>seeds with many zeros can be problematic.</span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Mersenne Twister not as good as PCG64.</span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Be particularly cautious to use a good RNG when doing permutation and taking random samples.</span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a><span class="fu">## Floating point precision</span></span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a><span class="fl">0.3</span> <span class="op">-</span> <span class="fl">0.2</span> <span class="op">==</span> <span class="fl">0.1</span></span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a><span class="fl">0.3</span></span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a><span class="fl">0.2</span></span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a><span class="fl">0.1</span> <span class="co"># Hmmm...</span></span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a><span class="fu">### Double-precision accuracy</span></span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a>Numbers in most languages are stored by default as double precision floating point numbers.</span>
<span id="cb48-117"><a href="#cb48-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-118"><a href="#cb48-118" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>8 bytes = 64 bits = double precision</span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>4 bytes = 32 bits = single precision</span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-121"><a href="#cb48-121" aria-hidden="true" tabindex="-1"></a>(GPU libraries often use 4 bytes or even fewer.)</span>
<span id="cb48-122"><a href="#cb48-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-123"><a href="#cb48-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-126"><a href="#cb48-126" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-127"><a href="#cb48-127" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dg(x, form <span class="op">=</span> <span class="st">'.20f'</span>):</span>
<span id="cb48-128"><a href="#cb48-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">format</span>(x, form))</span>
<span id="cb48-129"><a href="#cb48-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-130"><a href="#cb48-130" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb48-131"><a href="#cb48-131" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb48-132"><a href="#cb48-132" aria-hidden="true" tabindex="-1"></a>dg(a)</span>
<span id="cb48-133"><a href="#cb48-133" aria-hidden="true" tabindex="-1"></a>dg(b)</span>
<span id="cb48-134"><a href="#cb48-134" aria-hidden="true" tabindex="-1"></a>dg(a<span class="op">-</span>b)</span>
<span id="cb48-135"><a href="#cb48-135" aria-hidden="true" tabindex="-1"></a>dg(<span class="fl">0.1</span>)</span>
<span id="cb48-136"><a href="#cb48-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-137"><a href="#cb48-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-138"><a href="#cb48-138" aria-hidden="true" tabindex="-1"></a>How many digits of accuracy do we have?</span>
<span id="cb48-139"><a href="#cb48-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-140"><a href="#cb48-140" aria-hidden="true" tabindex="-1"></a>Same thing regardless of the size of the number:</span>
<span id="cb48-141"><a href="#cb48-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-144"><a href="#cb48-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-145"><a href="#cb48-145" aria-hidden="true" tabindex="-1"></a><span class="fl">12345678.1234567812345678</span></span>
<span id="cb48-146"><a href="#cb48-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-149"><a href="#cb48-149" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-150"><a href="#cb48-150" aria-hidden="true" tabindex="-1"></a><span class="fl">12345678123456781234.5678</span></span>
<span id="cb48-151"><a href="#cb48-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-154"><a href="#cb48-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-155"><a href="#cb48-155" aria-hidden="true" tabindex="-1"></a>dg(<span class="fl">12345678123456781234.5678</span>)</span>
<span id="cb48-156"><a href="#cb48-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-157"><a href="#cb48-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-158"><a href="#cb48-158" aria-hidden="true" tabindex="-1"></a>This occurs because of how the 64 bits in a double precision floating point number are allocated to give a large range of numbers in terms of magnitude and high precision in terms of digits of accuracy.</span>
<span id="cb48-159"><a href="#cb48-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-160"><a href="#cb48-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-161"><a href="#cb48-161" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparisons</span></span>
<span id="cb48-162"><a href="#cb48-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-163"><a href="#cb48-163" aria-hidden="true" tabindex="-1"></a>Let's see what kinds of numbers we can safely compare for exact equality with <span class="in">`==`</span>.</span>
<span id="cb48-164"><a href="#cb48-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-167"><a href="#cb48-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-168"><a href="#cb48-168" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb48-169"><a href="#cb48-169" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">.5</span> <span class="op">-</span> <span class="fl">.2</span></span>
<span id="cb48-170"><a href="#cb48-170" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="fl">0.3</span></span>
<span id="cb48-171"><a href="#cb48-171" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">1.5</span> <span class="op">-</span> <span class="fl">.2</span></span>
<span id="cb48-172"><a href="#cb48-172" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="fl">0.3</span></span>
<span id="cb48-173"><a href="#cb48-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-174"><a href="#cb48-174" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">.5</span> <span class="op">-</span> <span class="fl">.5</span></span>
<span id="cb48-175"><a href="#cb48-175" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb48-176"><a href="#cb48-176" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">.5</span> <span class="op">-</span> <span class="fl">.2</span>  <span class="op">-</span><span class="fl">.3</span></span>
<span id="cb48-177"><a href="#cb48-177" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb48-178"><a href="#cb48-178" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> (<span class="fl">.5</span> <span class="op">-</span> <span class="fl">.2</span>) <span class="op">-</span> (<span class="fl">.51</span> <span class="op">-</span> <span class="fl">.21</span>)</span>
<span id="cb48-179"><a href="#cb48-179" aria-hidden="true" tabindex="-1"></a>x <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb48-180"><a href="#cb48-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-181"><a href="#cb48-181" aria-hidden="true" tabindex="-1"></a>np.isclose(x, <span class="dv">0</span>)</span>
<span id="cb48-182"><a href="#cb48-182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-183"><a href="#cb48-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-184"><a href="#cb48-184" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calculation errors</span></span>
<span id="cb48-185"><a href="#cb48-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-186"><a href="#cb48-186" aria-hidden="true" tabindex="-1"></a>Let's consider accuracy of subtraction.</span>
<span id="cb48-187"><a href="#cb48-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-190"><a href="#cb48-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-191"><a href="#cb48-191" aria-hidden="true" tabindex="-1"></a><span class="fl">1.1234</span> <span class="op">-</span> <span class="fl">1.0</span></span>
<span id="cb48-192"><a href="#cb48-192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-195"><a href="#cb48-195" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-196"><a href="#cb48-196" aria-hidden="true" tabindex="-1"></a><span class="fl">123456781234.1234</span> <span class="op">-</span> <span class="fl">123456781234.0</span></span>
<span id="cb48-197"><a href="#cb48-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-198"><a href="#cb48-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-199"><a href="#cb48-199" aria-hidden="true" tabindex="-1"></a>This is called catastrophic cancellation.</span>
<span id="cb48-200"><a href="#cb48-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-201"><a href="#cb48-201" aria-hidden="true" tabindex="-1"></a>Do you think calling it "catastrophic" is too extreme? If so, consider this.</span>
<span id="cb48-202"><a href="#cb48-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-205"><a href="#cb48-205" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-206"><a href="#cb48-206" aria-hidden="true" tabindex="-1"></a><span class="fl">81.0</span> <span class="op">-</span> <span class="fl">80.0</span></span>
<span id="cb48-207"><a href="#cb48-207" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-210"><a href="#cb48-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-211"><a href="#cb48-211" aria-hidden="true" tabindex="-1"></a><span class="fl">12345678123456781.0</span> <span class="op">-</span><span class="fl">12345678123456780.0</span></span>
<span id="cb48-212"><a href="#cb48-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-213"><a href="#cb48-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-214"><a href="#cb48-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-215"><a href="#cb48-215" aria-hidden="true" tabindex="-1"></a>What's the derivative of $sin(x)$? Let's see what kind of accuracy we can get.</span>
<span id="cb48-216"><a href="#cb48-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-219"><a href="#cb48-219" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-220"><a href="#cb48-220" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb48-221"><a href="#cb48-221" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> deriv(f, x, eps<span class="op">=</span><span class="fl">1e-8</span>):</span>
<span id="cb48-222"><a href="#cb48-222" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> (f(x<span class="op">+</span>eps) <span class="op">-</span> f(x)) <span class="op">/</span> eps</span>
<span id="cb48-223"><a href="#cb48-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-224"><a href="#cb48-224" aria-hidden="true" tabindex="-1"></a>np.cos(<span class="fl">0.2</span>)</span>
<span id="cb48-225"><a href="#cb48-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-226"><a href="#cb48-226" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>)</span>
<span id="cb48-227"><a href="#cb48-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-228"><a href="#cb48-228" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-12</span>)</span>
<span id="cb48-229"><a href="#cb48-229" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-14</span>)</span>
<span id="cb48-230"><a href="#cb48-230" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-15</span>)</span>
<span id="cb48-231"><a href="#cb48-231" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-16</span>)</span>
<span id="cb48-232"><a href="#cb48-232" aria-hidden="true" tabindex="-1"></a>deriv(np.sin, <span class="fl">0.2</span>, <span class="fl">1e-17</span>)</span>
<span id="cb48-233"><a href="#cb48-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-234"><a href="#cb48-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-235"><a href="#cb48-235" aria-hidden="true" tabindex="-1"></a><span class="fu">### Linear algebra errors</span></span>
<span id="cb48-236"><a href="#cb48-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-237"><a href="#cb48-237" aria-hidden="true" tabindex="-1"></a>The errors seen in doing calculations, such as catastrophic cancellation, cascaded through derivative estimation. That also happens when doing linear algebra operations.</span>
<span id="cb48-238"><a href="#cb48-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-239"><a href="#cb48-239" aria-hidden="true" tabindex="-1"></a>Here's an example where mathematically all the eigenvalues are real-valued and positive, but not on the computer.</span>
<span id="cb48-240"><a href="#cb48-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-243"><a href="#cb48-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-244"><a href="#cb48-244" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy <span class="im">as</span> sp</span>
<span id="cb48-245"><a href="#cb48-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-246"><a href="#cb48-246" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> np.arange(<span class="dv">100</span>)</span>
<span id="cb48-247"><a href="#cb48-247" aria-hidden="true" tabindex="-1"></a>dists <span class="op">=</span> np.<span class="bu">abs</span>(xs[:, np.newaxis] <span class="op">-</span> xs)</span>
<span id="cb48-248"><a href="#cb48-248" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a p.d. matrix (mathematically).</span></span>
<span id="cb48-249"><a href="#cb48-249" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="op">=</span> np.exp(<span class="op">-</span>(dists<span class="op">/</span><span class="dv">10</span>)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb48-250"><a href="#cb48-250" aria-hidden="true" tabindex="-1"></a><span class="co"># But not numerically...</span></span>
<span id="cb48-251"><a href="#cb48-251" aria-hidden="true" tabindex="-1"></a>sp.linalg.eigvals(corr_matrix)[<span class="dv">80</span>:<span class="dv">99</span>]</span>
<span id="cb48-252"><a href="#cb48-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-253"><a href="#cb48-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-254"><a href="#cb48-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-255"><a href="#cb48-255" aria-hidden="true" tabindex="-1"></a><span class="fu">### Overflow and underflow</span></span>
<span id="cb48-256"><a href="#cb48-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-257"><a href="#cb48-257" aria-hidden="true" tabindex="-1"></a>Having a finite number of bits to represent each number means there are minimum and maximum numbers that can be expressed.</span>
<span id="cb48-258"><a href="#cb48-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-261"><a href="#cb48-261" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-262"><a href="#cb48-262" aria-hidden="true" tabindex="-1"></a><span class="fl">1.38e5000</span></span>
<span id="cb48-263"><a href="#cb48-263" aria-hidden="true" tabindex="-1"></a><span class="fl">1.38e-400</span></span>
<span id="cb48-264"><a href="#cb48-264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-265"><a href="#cb48-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-266"><a href="#cb48-266" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb48-267"><a href="#cb48-267" aria-hidden="true" tabindex="-1"></a><span class="fu">## How much do we need to worry about overflow and underflow?</span></span>
<span id="cb48-268"><a href="#cb48-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-269"><a href="#cb48-269" aria-hidden="true" tabindex="-1"></a>Q: Roughly how many observations would it take before we underflow in calculating a likelihood?</span>
<span id="cb48-270"><a href="#cb48-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-271"><a href="#cb48-271" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>10</span>
<span id="cb48-272"><a href="#cb48-272" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>100</span>
<span id="cb48-273"><a href="#cb48-273" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>1000</span>
<span id="cb48-274"><a href="#cb48-274" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>100000</span>
<span id="cb48-275"><a href="#cb48-275" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>100000000</span>
<span id="cb48-276"><a href="#cb48-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-277"><a href="#cb48-277" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-278"><a href="#cb48-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-281"><a href="#cb48-281" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-282"><a href="#cb48-282" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-283"><a href="#cb48-283" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy <span class="im">as</span> sp</span>
<span id="cb48-284"><a href="#cb48-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-285"><a href="#cb48-285" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb48-286"><a href="#cb48-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-287"><a href="#cb48-287" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size<span class="op">=</span>n)</span>
<span id="cb48-288"><a href="#cb48-288" aria-hidden="true" tabindex="-1"></a>np.prod(sp.stats.norm.pdf(x))</span>
<span id="cb48-289"><a href="#cb48-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-290"><a href="#cb48-290" aria-hidden="true" tabindex="-1"></a>loglik <span class="op">=</span> np.<span class="bu">sum</span>(sp.stats.norm.logpdf(x))</span>
<span id="cb48-291"><a href="#cb48-291" aria-hidden="true" tabindex="-1"></a>loglik</span>
<span id="cb48-292"><a href="#cb48-292" aria-hidden="true" tabindex="-1"></a>np.exp(loglik)</span>
<span id="cb48-293"><a href="#cb48-293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-294"><a href="#cb48-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-295"><a href="#cb48-295" aria-hidden="true" tabindex="-1"></a>::: {callout-important}</span>
<span id="cb48-296"><a href="#cb48-296" aria-hidden="true" tabindex="-1"></a><span class="fu">## Work with probabilities and densities on the log scale. Almost always.</span></span>
<span id="cb48-297"><a href="#cb48-297" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-298"><a href="#cb48-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-299"><a href="#cb48-299" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise: numerical issues with Newton's method</span></span>
<span id="cb48-300"><a href="#cb48-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-301"><a href="#cb48-301" aria-hidden="true" tabindex="-1"></a>Look at your partner's code in terms of how it handles the stopping criterion or (for the 1-d case) the finite difference estimate of the gradient and Hessian.</span>
<span id="cb48-302"><a href="#cb48-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-303"><a href="#cb48-303" aria-hidden="true" tabindex="-1"></a>Make a pull request that tries to improve how that is handled.</span>
<span id="cb48-304"><a href="#cb48-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-305"><a href="#cb48-305" aria-hidden="true" tabindex="-1"></a>Then review the pull request your partner makes in your repository.</span>
<span id="cb48-306"><a href="#cb48-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-307"><a href="#cb48-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-308"><a href="#cb48-308" aria-hidden="true" tabindex="-1"></a><span class="fu"># 9. Packaging and Conda environments</span></span>
<span id="cb48-309"><a href="#cb48-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-310"><a href="#cb48-310" aria-hidden="true" tabindex="-1"></a><span class="fu">## Basic Python packages</span></span>
<span id="cb48-311"><a href="#cb48-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-312"><a href="#cb48-312" aria-hidden="true" tabindex="-1"></a>What's a package? In general it is software that is provided as a bundle that can be downloaded and made available on your computer.</span>
<span id="cb48-313"><a href="#cb48-313" aria-hidden="true" tabindex="-1"></a>Some packages (e.g., R, Python themselves) are stand-alone packages. Others (such as R packages and Python packages) are add-on functionality that works with stand-alone software.</span>
<span id="cb48-314"><a href="#cb48-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-315"><a href="#cb48-315" aria-hidden="true" tabindex="-1"></a>What do we need to have a Python package?</span>
<span id="cb48-316"><a href="#cb48-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-317"><a href="#cb48-317" aria-hidden="true" tabindex="-1"></a><span class="fu">### Packages</span></span>
<span id="cb48-318"><a href="#cb48-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-319"><a href="#cb48-319" aria-hidden="true" tabindex="-1"></a>A Python package is a directory containing one or more modules and with a file</span>
<span id="cb48-320"><a href="#cb48-320" aria-hidden="true" tabindex="-1"></a>named <span class="in">`__init__.py`</span> that is called when a package is imported and</span>
<span id="cb48-321"><a href="#cb48-321" aria-hidden="true" tabindex="-1"></a>serves to initialize the package.</span>
<span id="cb48-322"><a href="#cb48-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-323"><a href="#cb48-323" aria-hidden="true" tabindex="-1"></a>Let's create a basic package.</span>
<span id="cb48-324"><a href="#cb48-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-325"><a href="#cb48-325" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb48-326"><a href="#cb48-326" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> mypkg</span>
<span id="cb48-327"><a href="#cb48-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-328"><a href="#cb48-328" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mypkg/__init__.py</span>
<span id="cb48-329"><a href="#cb48-329" aria-hidden="true" tabindex="-1"></a><span class="st">## Make objects from mymod.py available as mypkg.foo</span></span>
<span id="cb48-330"><a href="#cb48-330" aria-hidden="true" tabindex="-1"></a><span class="st">from mypkg.mymod import *</span></span>
<span id="cb48-331"><a href="#cb48-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-332"><a href="#cb48-332" aria-hidden="true" tabindex="-1"></a><span class="st">print("Welcome to my package.")</span></span>
<span id="cb48-333"><a href="#cb48-333" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb48-334"><a href="#cb48-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-335"><a href="#cb48-335" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mypkg/mymod.py</span>
<span id="cb48-336"><a href="#cb48-336" aria-hidden="true" tabindex="-1"></a><span class="st">x = 7</span></span>
<span id="cb48-337"><a href="#cb48-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-338"><a href="#cb48-338" aria-hidden="true" tabindex="-1"></a><span class="st">def myfun(val):</span></span>
<span id="cb48-339"><a href="#cb48-339" aria-hidden="true" tabindex="-1"></a><span class="st">    print("The arg is: ", str(val), ".", sep = '')</span></span>
<span id="cb48-340"><a href="#cb48-340" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb48-341"><a href="#cb48-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-342"><a href="#cb48-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-343"><a href="#cb48-343" aria-hidden="true" tabindex="-1"></a>Note that if there were other modules, we could have imported from those as well.</span>
<span id="cb48-344"><a href="#cb48-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-345"><a href="#cb48-345" aria-hidden="true" tabindex="-1"></a>Now we can use the objects from the module without having to know</span>
<span id="cb48-346"><a href="#cb48-346" aria-hidden="true" tabindex="-1"></a>that it was in a particular module (because of how <span class="in">`__init__.py`</span> was set up).</span>
<span id="cb48-347"><a href="#cb48-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-350"><a href="#cb48-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-351"><a href="#cb48-351" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb48-352"><a href="#cb48-352" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mypkg</span>
<span id="cb48-353"><a href="#cb48-353" aria-hidden="true" tabindex="-1"></a>mypkg.x</span>
<span id="cb48-354"><a href="#cb48-354" aria-hidden="true" tabindex="-1"></a>mypkg.myfun(<span class="dv">7</span>)</span>
<span id="cb48-355"><a href="#cb48-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-356"><a href="#cb48-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-357"><a href="#cb48-357" aria-hidden="true" tabindex="-1"></a>Note that one can set <span class="in">`__all__`</span> in an <span class="in">`__init__.py`</span> to define what is imported,</span>
<span id="cb48-358"><a href="#cb48-358" aria-hidden="true" tabindex="-1"></a>which makes clear what is publicly available and hides what is considered</span>
<span id="cb48-359"><a href="#cb48-359" aria-hidden="true" tabindex="-1"></a>internal.</span>
<span id="cb48-360"><a href="#cb48-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-361"><a href="#cb48-361" aria-hidden="true" tabindex="-1"></a><span class="fu">### A minimal "real" package</span></span>
<span id="cb48-362"><a href="#cb48-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-363"><a href="#cb48-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-364"><a href="#cb48-364" aria-hidden="true" tabindex="-1"></a>Fernando has a <span class="co">[</span><span class="ot">this toy example package</span><span class="co">](https://github.com/fperez/mytoy)</span>.</span>
<span id="cb48-365"><a href="#cb48-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-366"><a href="#cb48-366" aria-hidden="true" tabindex="-1"></a>Let's clone the repository and see if we can install it.</span>
<span id="cb48-367"><a href="#cb48-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-368"><a href="#cb48-368" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb48-369"><a href="#cb48-369" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/fperez/mytoy</span>
<span id="cb48-370"><a href="#cb48-370" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> mytoy</span>
<span id="cb48-371"><a href="#cb48-371" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">--user</span> .</span>
<span id="cb48-372"><a href="#cb48-372" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span></span>
<span id="cb48-373"><a href="#cb48-373" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> .local/lib/python3.11/site-packages</span>
<span id="cb48-374"><a href="#cb48-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-375"><a href="#cb48-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-378"><a href="#cb48-378" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb48-379"><a href="#cb48-379" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb48-380"><a href="#cb48-380" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mytoy</span>
<span id="cb48-381"><a href="#cb48-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-382"><a href="#cb48-382" aria-hidden="true" tabindex="-1"></a>mytoy.toy(<span class="dv">7</span>)</span>
<span id="cb48-383"><a href="#cb48-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-384"><a href="#cb48-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-385"><a href="#cb48-385" aria-hidden="true" tabindex="-1"></a>It would take more work to make the package available in a repository such as PyPI or via Conda.</span>
<span id="cb48-386"><a href="#cb48-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-387"><a href="#cb48-387" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise</span></span>
<span id="cb48-388"><a href="#cb48-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-389"><a href="#cb48-389" aria-hidden="true" tabindex="-1"></a>Make a package out of your Newton method code, following the structure of <span class="in">`mytoy`</span>. Include your tests as part of the package.</span>
<span id="cb48-390"><a href="#cb48-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-391"><a href="#cb48-391" aria-hidden="true" tabindex="-1"></a>See if you can install your package, run the tests, and use the package, following the <span class="in">`README.md`</span> of <span class="in">`mytoy`</span>.</span>
<span id="cb48-392"><a href="#cb48-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-393"><a href="#cb48-393" aria-hidden="true" tabindex="-1"></a><span class="fu">## Installing packages</span></span>
<span id="cb48-394"><a href="#cb48-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-395"><a href="#cb48-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-396"><a href="#cb48-396" aria-hidden="true" tabindex="-1"></a>If a package is on PyPI or available through Conda but not on your system, you can install it</span>
<span id="cb48-397"><a href="#cb48-397" aria-hidden="true" tabindex="-1"></a>easily (usually). You don't need root permission on a machine to install</span>
<span id="cb48-398"><a href="#cb48-398" aria-hidden="true" tabindex="-1"></a>a package, though you may need to use <span class="in">`pip install --user`</span> or set up a new Conda environment.</span>
<span id="cb48-399"><a href="#cb48-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-400"><a href="#cb48-400" aria-hidden="true" tabindex="-1"></a>Packages often depend on other packages. In general, if one package depends on another,</span>
<span id="cb48-401"><a href="#cb48-401" aria-hidden="true" tabindex="-1"></a>pip or conda will generally install the dependency automatically.</span>
<span id="cb48-402"><a href="#cb48-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-403"><a href="#cb48-403" aria-hidden="true" tabindex="-1"></a>One advantage of Conda is that it can also install non-Python packages on which a Python</span>
<span id="cb48-404"><a href="#cb48-404" aria-hidden="true" tabindex="-1"></a>package depends, whereas with pip you sometimes need to install a system package to</span>
<span id="cb48-405"><a href="#cb48-405" aria-hidden="true" tabindex="-1"></a>satisfy a dependency.</span>
<span id="cb48-406"><a href="#cb48-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-407"><a href="#cb48-407" aria-hidden="true" tabindex="-1"></a>It's not uncommon to run into a case where conda has trouble installing a package</span>
<span id="cb48-408"><a href="#cb48-408" aria-hidden="true" tabindex="-1"></a>because of version inconsistencies amongst the dependencies. <span class="in">`mamba`</span> is a drop-in</span>
<span id="cb48-409"><a href="#cb48-409" aria-hidden="true" tabindex="-1"></a>replacement for <span class="in">`conda`</span> and often does a better job of this "dependency resolution".</span>
<span id="cb48-410"><a href="#cb48-410" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">We use `mamba` by default on the SCF</span><span class="co">](https://statistics.berkeley.edu/computing/software/install)</span>.</span>
<span id="cb48-411"><a href="#cb48-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-412"><a href="#cb48-412" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reproducibility and package management</span></span>
<span id="cb48-413"><a href="#cb48-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-414"><a href="#cb48-414" aria-hidden="true" tabindex="-1"></a>For reproducibility, it's important to know the versions of the packages you use (and the version of Python).</span>
<span id="cb48-415"><a href="#cb48-415" aria-hidden="true" tabindex="-1"></a><span class="in">`pip`</span> and <span class="in">`conda`</span> make it easy to do this. You can create a *requirements* file that captures the packages you are currently using (and, critically, their versions) and then install exactly that set of packages (and versions) based on that requirements file.</span>
<span id="cb48-416"><a href="#cb48-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-417"><a href="#cb48-417" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb48-418"><a href="#cb48-418" aria-hidden="true" tabindex="-1"></a><span class="co">## Reproducing using pip.</span></span>
<span id="cb48-419"><a href="#cb48-419" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> freeze <span class="op">&gt;</span> requirements.txt</span>
<span id="cb48-420"><a href="#cb48-420" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb48-421"><a href="#cb48-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-422"><a href="#cb48-422" aria-hidden="true" tabindex="-1"></a><span class="co">## Reproducing a Conda environment.</span></span>
<span id="cb48-423"><a href="#cb48-423" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env export <span class="op">&gt;</span> environment.yml</span>
<span id="cb48-424"><a href="#cb48-424" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create <span class="at">-f</span> environment.yml</span>
<span id="cb48-425"><a href="#cb48-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-426"><a href="#cb48-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-427"><a href="#cb48-427" aria-hidden="true" tabindex="-1"></a>Conda is a general package manager. You can use it to manage Python packages but lots of other software as well, including R and Julia.</span>
<span id="cb48-428"><a href="#cb48-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-429"><a href="#cb48-429" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fully isolating your Conda environment</span></span>
<span id="cb48-430"><a href="#cb48-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-431"><a href="#cb48-431" aria-hidden="true" tabindex="-1"></a>Conda environments provide an additional layer of modularity/reproducibility, allowing you to set up a fully reproducible environment for your computation. Here (by explicitly giving <span class="in">`python=3.11`</span>) the Python 3.11 executable and all packages you install in the environment are fully independent (there are <span class="co">[</span><span class="ot">some caveats</span><span class="co">](https://statistics.berkeley.edu/computing/software/install#conda-isolate)</span> of whatever Python executables are installed on the system.</span>
<span id="cb48-432"><a href="#cb48-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-433"><a href="#cb48-433" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb48-434"><a href="#cb48-434" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> python</span>
<span id="cb48-435"><a href="#cb48-435" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-n</span> my_iso_env python=3.11</span>
<span id="cb48-436"><a href="#cb48-436" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> activate my_iso_env</span>
<span id="cb48-437"><a href="#cb48-437" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> python</span>
<span id="cb48-438"><a href="#cb48-438" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install numpy</span>
<span id="cb48-439"><a href="#cb48-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-440"><a href="#cb48-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-441"><a href="#cb48-441" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb48-442"><a href="#cb48-442" aria-hidden="true" tabindex="-1"></a><span class="fu">## Activating an environment</span></span>
<span id="cb48-443"><a href="#cb48-443" aria-hidden="true" tabindex="-1"></a>If you use <span class="in">`conda activate`</span> rather than <span class="in">`source activate`</span>, Conda will prompt you to run <span class="in">`conda init`</span>, which will make changes to your <span class="in">`~/.bashrc`</span> that, for one, activate the Conda base environment automatically when a shell is started. This may be fine, but it's helpful to be aware.</span>
<span id="cb48-444"><a href="#cb48-444" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-445"><a href="#cb48-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-446"><a href="#cb48-446" aria-hidden="true" tabindex="-1"></a><span class="fu">### Package locations</span></span>
<span id="cb48-447"><a href="#cb48-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-448"><a href="#cb48-448" aria-hidden="true" tabindex="-1"></a>Packages in Python (and in R, Julia, etc.) may be installed in various places</span>
<span id="cb48-449"><a href="#cb48-449" aria-hidden="true" tabindex="-1"></a>on the filesystem, and it sometimes it is helpful (e.g., if you end up with multiple</span>
<span id="cb48-450"><a href="#cb48-450" aria-hidden="true" tabindex="-1"></a>versions of a package installed on your system) to be able to figure out </span>
<span id="cb48-451"><a href="#cb48-451" aria-hidden="true" tabindex="-1"></a>where on the filesystem the package is being loaded from. </span>
<span id="cb48-452"><a href="#cb48-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-453"><a href="#cb48-453" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`pkgname.__file__`</span> will show where the imported package is installed.</span>
<span id="cb48-454"><a href="#cb48-454" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`pkname.__version__`</span> will show the version of the package (as will <span class="in">`pip list`</span> or <span class="in">`conda list`</span>, for all packages).</span>
<span id="cb48-455"><a href="#cb48-455" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`sys.path`</span> shows where Python looks for packages on your system.</span>
<span id="cb48-456"><a href="#cb48-456" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>packages installed via <span class="in">`pip`</span> will generally be in <span class="in">`~/.local/lib/python3.X/site-packages`</span>.</span>
<span id="cb48-457"><a href="#cb48-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-458"><a href="#cb48-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-459"><a href="#cb48-459" aria-hidden="true" tabindex="-1"></a><span class="fu">### Source vs. binary packages</span></span>
<span id="cb48-460"><a href="#cb48-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-461"><a href="#cb48-461" aria-hidden="true" tabindex="-1"></a>The difference between a *source* package and a *binary* package is that</span>
<span id="cb48-462"><a href="#cb48-462" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>a *source* package has the raw Python (and C/C++ and Fortran, in some cases) code</span>
<span id="cb48-463"><a href="#cb48-463" aria-hidden="true" tabindex="-1"></a>as text files</span>
<span id="cb48-464"><a href="#cb48-464" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>a *binary* package has all the non-Python code in a binary/non-text format, with the  C/C++ and Fortran code already having been compiled.</span>
<span id="cb48-465"><a href="#cb48-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-466"><a href="#cb48-466" aria-hidden="true" tabindex="-1"></a>If you install a package from source, C/C++/Fortran code will be compiled on your system</span>
<span id="cb48-467"><a href="#cb48-467" aria-hidden="true" tabindex="-1"></a>(if the package has such code).</span>
<span id="cb48-468"><a href="#cb48-468" aria-hidden="true" tabindex="-1"></a>That should mean the compiled code will work on your system, but requires you to have a</span>
<span id="cb48-469"><a href="#cb48-469" aria-hidden="true" tabindex="-1"></a>compiler available and things properly configured. A binary package doesn't need to be</span>
<span id="cb48-470"><a href="#cb48-470" aria-hidden="true" tabindex="-1"></a>compiled on your system, but in some cases (e.g., if you got the wrong binary version) the code may not run on your system because</span>
<span id="cb48-471"><a href="#cb48-471" aria-hidden="true" tabindex="-1"></a>it was compiled in such a way that is not compatible with your system.</span>
<span id="cb48-472"><a href="#cb48-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-473"><a href="#cb48-473" aria-hidden="true" tabindex="-1"></a>Python *wheels* are a binary package format for Python packages. Wheels for some packages will vary by platform</span>
<span id="cb48-474"><a href="#cb48-474" aria-hidden="true" tabindex="-1"></a>(i.e., operating system) so that the package will install correctly on the system where it is being installed.</span>
<span id="cb48-475"><a href="#cb48-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-476"><a href="#cb48-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-477"><a href="#cb48-477" aria-hidden="true" tabindex="-1"></a><span class="fu"># 10. GitHub Actions and Continuous Integration</span></span>
<span id="cb48-478"><a href="#cb48-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-479"><a href="#cb48-479" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">VERY MUCH UNDER CONSTRUCTION</span><span class="co">]</span></span>
<span id="cb48-480"><a href="#cb48-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-481"><a href="#cb48-481" aria-hidden="true" tabindex="-1"></a>Having reproducible environments (e.g., Conda environments or Docker containers) provides the ability to run (and automate) various actions to run on remote/cloud computational resources and know that they (should) work.</span>
<span id="cb48-482"><a href="#cb48-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-483"><a href="#cb48-483" aria-hidden="true" tabindex="-1"></a>::: {callout-tip}</span>
<span id="cb48-484"><a href="#cb48-484" aria-hidden="true" tabindex="-1"></a><span class="fu">## Docker containers</span></span>
<span id="cb48-485"><a href="#cb48-485" aria-hidden="true" tabindex="-1"></a>Docker containers share some similarities with Conda environments except that you provide a full specification for the Linux operating system you want to use and software you want installed.</span>
<span id="cb48-486"><a href="#cb48-486" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb48-487"><a href="#cb48-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-488"><a href="#cb48-488" aria-hidden="true" tabindex="-1"></a>You need to provide the recipe for the environment or container. The automation system can then set up the environment as a virtual environment/container on the remote machine and run the action/code you request. This could simply be giving you a terminal or starting a Jupyter notebook in the environment and giving you access via your browser.</span>
<span id="cb48-489"><a href="#cb48-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-490"><a href="#cb48-490" aria-hidden="true" tabindex="-1"></a>Below are a couple examples.</span>
<span id="cb48-491"><a href="#cb48-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-492"><a href="#cb48-492" aria-hidden="true" tabindex="-1"></a>There are a lot more out there. In fact, DataHub is based on Docker containers (and a container management service called Kubernetes). Let's see what OS is being run in the container that your DataHub server is using.</span>
<span id="cb48-493"><a href="#cb48-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-494"><a href="#cb48-494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-495"><a href="#cb48-495" aria-hidden="true" tabindex="-1"></a><span class="in">$ cat /etc/issue</span></span>
<span id="cb48-496"><a href="#cb48-496" aria-hidden="true" tabindex="-1"></a><span class="in">Ubuntu 22.04.4 LTS \n \l</span></span>
<span id="cb48-497"><a href="#cb48-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-498"><a href="#cb48-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-499"><a href="#cb48-499" aria-hidden="true" tabindex="-1"></a><span class="fu">## Binder</span></span>
<span id="cb48-500"><a href="#cb48-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-501"><a href="#cb48-501" aria-hidden="true" tabindex="-1"></a>One example is using Binder to open a Jupyter notebook in an executable environment.</span>
<span id="cb48-502"><a href="#cb48-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-503"><a href="#cb48-503" aria-hidden="true" tabindex="-1"></a>Based on a configuration (various options are possible for how to specify the configuration), Binder will create a Docker container with the needed software installed.</span>
<span id="cb48-504"><a href="#cb48-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-505"><a href="#cb48-505" aria-hidden="true" tabindex="-1"></a>The most common configuration format is to provide a Conda environment file. Binder will then create a Conda environment inside the Docker (Linux) container. The Conda environment will contain the packages specified in the environment file. </span>
<span id="cb48-506"><a href="#cb48-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-507"><a href="#cb48-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-508"><a href="#cb48-508" aria-hidden="true" tabindex="-1"></a>Let's set up a Binder environment "Geospatial analytics in Python with Geopandas" that can access the <span class="co">[</span><span class="ot">notebooks and materials provided in the repository</span><span class="co">](https://github.com/jorisvandenbossche/geopandas-tutorial)</span> in a <span class="co">[</span><span class="ot">computational environment</span><span class="co">](https://github.com/jorisvandenbossche/geopandas-tutorial/blob/main/environment.yml)</span> designed to use the notebooks reliably and reproducibly. </span>
<span id="cb48-509"><a href="#cb48-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-510"><a href="#cb48-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-511"><a href="#cb48-511" aria-hidden="true" tabindex="-1"></a>In some cases an *image* for the container will already be available, and all that needs to happen is to start a virtual machine using that image as the computational environment.</span>
<span id="cb48-512"><a href="#cb48-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-513"><a href="#cb48-513" aria-hidden="true" tabindex="-1"></a>In other cases (e.g., with a configuration you've just created), the Docker container and Conda environment need to be set up.</span>
<span id="cb48-514"><a href="#cb48-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-515"><a href="#cb48-515" aria-hidden="true" tabindex="-1"></a>If we're familiar with what happens when Docker containers and Conda environments are set up, we can see in the Binder logs that a Docker container is set up (using Ubuntu Linux) and one of the steps of doing that is to create a Conda environment within the container. We'll see that if we use the <span class="in">`mytoy`</span> repository to start a Binder environment at <span class="in">`ovh.mybinder.org`</span>, specifying <span class="in">`fperez/mytoy`</span> as the repository. (Note that in a number of cases, the startup has failed, probably because <span class="in">`mybinder`</span> has very limited resources for providing cloud compute resources. I am using <span class="in">`ovh.mybinder.org`</span> rather than <span class="in">`mybinder.org`</span> in hopes that is more likely to succeed.</span>
<span id="cb48-516"><a href="#cb48-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-517"><a href="#cb48-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-518"><a href="#cb48-518" aria-hidden="true" tabindex="-1"></a><span class="fu">## GitHub Actions</span></span>
<span id="cb48-519"><a href="#cb48-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-520"><a href="#cb48-520" aria-hidden="true" tabindex="-1"></a>A second example is using GitHub Actions (GHA) to automate activities such as testing. To set up a GitHub Actions workflow, one</span>
<span id="cb48-521"><a href="#cb48-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-522"><a href="#cb48-522" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>specifies when the workflow will run (e.g., when a push or pull request is made, or only manually)</span>
<span id="cb48-523"><a href="#cb48-523" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>provides instructions for how to set up the environment for the workflow</span>
<span id="cb48-524"><a href="#cb48-524" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>provides the operations that the workflow should run.</span>
<span id="cb48-525"><a href="#cb48-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-526"><a href="#cb48-526" aria-hidden="true" tabindex="-1"></a>A good example is running tests whenever you make a commit to a repository containing software.</span>
<span id="cb48-527"><a href="#cb48-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-528"><a href="#cb48-528" aria-hidden="true" tabindex="-1"></a>With GHA, you specify the operating system and then run the steps you specify in <span class="in">`.github/workflows/some_action.yml`</span>. Some steps will  customize the environment as the initial steps and then additional step(s) will run shell or other code to run your workflow. You use pre-specified operations (called *actions*) to do common things (such as checking out a GitHub repository and installing commonly used software). </span>
<span id="cb48-529"><a href="#cb48-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-530"><a href="#cb48-530" aria-hidden="true" tabindex="-1"></a>GH will then run the steps in a virtual machine, which is called the *runner*.</span>
<span id="cb48-531"><a href="#cb48-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-532"><a href="#cb48-532" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">TODO: Find an interesting repo with automated testing set up</span><span class="co">]</span></span>
<span id="cb48-533"><a href="#cb48-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-534"><a href="#cb48-534" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">TODO: show how environment is created</span><span class="co">]</span></span>
<span id="cb48-535"><a href="#cb48-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-536"><a href="#cb48-536" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">TODO: show how env is customized</span><span class="co">]</span></span>
<span id="cb48-537"><a href="#cb48-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-538"><a href="#cb48-538" aria-hidden="true" tabindex="-1"></a>This is all quite powerful, and the use of reproducible environments generally helps with debugging because you can also set up the environment on your own machine. That said, running code remotely or in the cloud can also be hard to debug at times.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>